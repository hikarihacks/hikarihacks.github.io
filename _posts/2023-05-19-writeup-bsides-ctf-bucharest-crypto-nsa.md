---
layout: post
title:  "Writeup for Bsides Bucharest 2023 Crypto Challenge : NSA"
tags: crypto ctf bsides
---

We were given the following challenge file:

```txt
N1 = 6262881595102772596725750518293278760761165447052954074003897243061307734638702128387340310907477227210221334526846670524149065129275879439338952467939839089005849586232832578187652701441129364609024293317002481170608423403700992665830272685742722331038875619076784973650172278076219825022344372426114886589253162815156669101604246617265063068871972069335155041717400588461789952175673332546770840178359421587162646828344694672012846508237497001745427889110818592019398530253105497375907340231828577710546631619945817386464817535476699140306879577083494704937073218078767296054640315366319278824526812504826253039301
N2 = 194087604941925350095166177215019364349357888051491152225236305737823699320753085245225661238915430109927623144758255372483573223940859963163916562416002548407497997412006876255838726969100641578918219277213498378131422131034081633037317239885423178869083020974817203673503065471389782348495325898823756351758506205495564863560902792602508580037796520148699010912740865934632599442848106392273571479906470101921192266672108019606402714478331952737316573617387479283433824255948995991495241008786228481068575804903816042457967881648962172074656441010796842165729667585427972435459672965683791432856429971536331524797
e = 65537
c1 = 4446929263399126765961234383944890423087391643868596168999570820531113761236412014854342156585508771733423183359934999581587726017423914355284979614570005044718676985015101940324876471863623969457194293981825052625311300161782976074075765282419607569297335472260304097227893820671730385752838938559384155629491357027637517069132876534106043016559047294336122971894624074013304756654649976202879466598269568142252030585542613509384939373675647520315823349814028958331424123236830380514867543771169995824259953484229838537185855632094211969810821179681514155164059491087126122746525516733642483270790407820394051550412
c2 = 41753178308444795139583870403101157736400819214374310031884984568806105501294689812578511925617253303847334433424634731449567301089666104714466089635741706170196962572130999277447355727965910349793631404408244029585264616141094288377327171784958255258378517452024286611638234457354849330115805192347090455849363938257638158266538997580448774084682363731084960997262712895007506038771957557077864393231308131512885550607621291486744847022415862822857834556466347749108466652452426834586062816506354674672920431484410632590388566623968305022545148611000290147882818736297004898058081091388890382019710487150500251035
```

Due to the fact that we were given 2 public keys and 2 pieces of ciphertext, it would be reasonable to assume that the public keys are somehow related. Let's try checking whether or not they have common divisors.

```py
#!/usr/bin/env python3
from sympy import gcd

N1 = 6262881595102772596725750518293278760761165447052954074003897243061307734638702128387340310907477227210221334526846670524149065129275879439338952467939839089005849586232832578187652701441129364609024293317002481170608423403700992665830272685742722331038875619076784973650172278076219825022344372426114886589253162815156669101604246617265063068871972069335155041717400588461789952175673332546770840178359421587162646828344694672012846508237497001745427889110818592019398530253105497375907340231828577710546631619945817386464817535476699140306879577083494704937073218078767296054640315366319278824526812504826253039301
N2 = 194087604941925350095166177215019364349357888051491152225236305737823699320753085245225661238915430109927623144758255372483573223940859963163916562416002548407497997412006876255838726969100641578918219277213498378131422131034081633037317239885423178869083020974817203673503065471389782348495325898823756351758506205495564863560902792602508580037796520148699010912740865934632599442848106392273571479906470101921192266672108019606402714478331952737316573617387479283433824255948995991495241008786228481068575804903816042457967881648962172074656441010796842165729667585427972435459672965683791432856429971536331524797

print(gcd(N1, N2))
```

After running the provided script, we can see that the numbers have a common divisor, which means that ew have one of the factors that have been multiplied in order to create the public key. After having one of the factors, the challenge turns into a basic RSA challenge where we have to decrypt a ciphertext knowing e, p and q.

Here is the script that I used in order to solve the challenge:

```py
#!/usr/bin/env python3
from sympy import gcd, mod_inverse
from Crypto.Util.number import long_to_bytes

def parse_inputs(fname : str):
    with open(fname) as f:
        contents = f.readlines()
        ns = contents[:2]
        ns = list(map(lambda x : int(x.strip().split(" ")[-1]), ns))
        cs = contents[:2:-1][::-1]
        cs = list(map(lambda x : int(x.strip().split(" ")[-1]), cs))
        return ns, cs

if __name__=="__main__":
    Ns, cs = parse_inputs('nsa.txt')
    p = gcd(Ns)
    
    e = 65537
    q = Ns[0] / p
    c = cs[0]

    phi = (p-1)*(q-1)
    d = mod_inverse(e, phi)
    m = pow(c, d, Ns[0])
    print(long_to_bytes(m))
```

Pretty sure you can decrypt the flag on your own :)

